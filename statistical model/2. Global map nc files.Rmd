---
output:
  html_document: default
  pdf_document: default
  word_document: default
---

---
title: "Global input for all prediction field"
author: "Yunke Peng"
date: "June 22 2020"
output: html_document
---

## Introduction about Global nc files

Elements below are global inputs that will be used in statistical model-based calculations:

 * Soil C/N
 * age
 * alpha
 * fAPAR
 * PPFD
 * Tg
 * vpd
 * LMA
 * Vcmax25

Each elements were derived from different sources, and some of them may be resampled from different resolutions.


#soil C/N

```{r}
library(raster)

soil <- raster('E:/final round/data/w001000.adf') # map input from the last 2015 version of ISRIC (Batjes 2015 ISRIC report)

Global_grid <- as.data.frame(read.csv(file="E:/climate/Global_cell.csv")) #Input global land grids (0.5 degree;N = 259200)

Global_grid$ID <- c(1:259200) #create a list of number, just helping to form a raster then.

pointXY<-SpatialPointsDataFrame(Global_grid[,c('lon','lat')], data=data.frame(unique.id=paste(Global_grid$ID))) # convert to spatial data format 

vec.soil.extract <-extract(soil,pointXY) 
data.soil.extract <-data.frame(pointXY,SUID=vec.soil.extract) 
# These two steps are important, it will extract SUID information from soil map to our grids data, so that each our global grid will have a SUID, which will be further combined (merged) with soil C/N data then.

ISRIC.data<-read.csv(file="E:/final round/HW30s_FULL.csv",header=TRUE,sep=";",dec = ".") # Now, input ISRIC database

data.soil.extract <- merge(data.soil.extract,ISRIC.data,by='SUID',all.x=TRUE) # merge site with soil variables by using SUID

data.soil.extract2 <- subset(data.soil.extract,CNrt>0) # select available CNrt
data.soil.extract3 <- data.soil.extract2[,c("lon","lat","CNrt")] # only select CNrt variable

ss1 <- aggregate(data.soil.extract3,by=list(data.soil.extract3$lon,data.soil.extract3$lat), FUN=mean, na.rm=TRUE) # note that in each grid there might be more than 1 samples measured, so we should aggregate them which make sures that one grid holds one data only.

ss2 <- ss1[,c(3,4,5)] # now,select lon, lat and CNrt only


final_CN <-Reduce(function(x,y) merge(x = x, y = y, by = c("lon","lat"),all.x=TRUE), 
                   list(Global_grid,ss2)) #merged this with global grids (N = 259200)

coordinates(final_CN) <- ~lon+lat 

gridded(final_CN) <- TRUE

rCNrt <- raster(final_CN, "CNrt") 
plot(rCNrt)

```



#stand age

```{r}
library(raster)
library(ncdf4)
#set the path and filename

ncfname <- paste ("E:/C-N cycling/Carbon allocation/672 sites analysis/stand age/GFAD_V1-1/", "GFAD_V1-1", ".nc", sep="")
dname <- "age"

#1. open a netCDF file and check variable
ncin <- nc_open(ncfname)
print(ncin)
summary(ncin) #here ncin includes 4 pfts at 15 age classes

#2. Get coordinate and value
lon <- ncvar_get(ncin,"lon")
nlon <- dim(lon) 

lat<-ncvar_get(ncin,"lat")
nlat<-dim(lat)

age <-ncvar_get(ncin,"age")

nc_close(ncin)

pre.vec.long <- as.vector(age)
length(pre.vec.long)

pre.mat <- matrix(pre.vec.long, nrow = nlon * nlat, ncol = 4*15) # 259200 * 420 - here it represents 4 PFTs and 15 age classes.

lonlat <- expand.grid(lon, lat)

#here we calculated age as a sum of 15 age classes in 4 plant functional types.
lonlat$age <- rowSums(pre.mat[,1:4])*5+rowSums(pre.mat[,5:8])*15+rowSums(pre.mat[,9:12])*25+rowSums(pre.mat[,13:16])*35+
  rowSums(pre.mat[,17:20])*45+rowSums(pre.mat[,21:24])*55+rowSums(pre.mat[,25:28])*65+rowSums(pre.mat[,29:32])*75+
  rowSums(pre.mat[,33:36])*85+rowSums(pre.mat[,37:40])*95+rowSums(pre.mat[,41:44])*105+rowSums(pre.mat[,45:48])*115+
  rowSums(pre.mat[,49:52])*125+rowSums(pre.mat[,53:56])*135+rowSums(pre.mat[,57:60])*145


names(lonlat) <- c("lon","lat","age")

age_input <- as.data.frame(lonlat)

coordinates(age_input) <- ~lon+lat 
gridded(age_input) <- TRUE

#2. check grids information and convert it to raster
class(age_input)
str(age_input@data)

r <- raster(age_input, "age") 

#3. Have a look at global map
class(r)
plot(r)

``` 
#fAPAR comes first
```{r}
######fAPAR######
ncpath <- "E:/C-N cycling/Carbon allocation/fAPAR/fAPAR HUANYUAN/"
ncname <- "fAPAR3g_v2_1982_2016_FILLED"
ncfname <- paste (ncpath, ncname, ".nc", sep="")
dname <- "FAPAR_FILLED"

# open a netCDF file and check variable
ncin <- nc_open(ncfname)

print(ncin)

# 2.2 Get coordinate (including time variables)
# Get longitude and latitude
lon <- ncvar_get(ncin,"LON")
nlon <- dim(lon) 
head(lon)

lat<-ncvar_get(ncin,"LAT")
nlat<-dim(lat)
head(lat)

Time <- ncvar_get(ncin,"TIME_bnds") # monthly 1982-2016
FAPAR <- ncvar_get(ncin,"FAPAR_FILLED")
dim(Time)

#rm(FAPAR)

print(c(nlon,nlat))

nc_close(ncin)

#for fAPAR

pre.vec.long <- as.vector(FAPAR)

pre.mat <- matrix(pre.vec.long, nrow = nlon * nlat, ncol = 420) # 259200 * 420 (420 is 35 years)
dim(pre.mat)

lonlat <- expand.grid(lon, lat)

#pre.df01 <- data.frame(cbind(lonlat, pre.mat))

# 422 row = lon, lat, monthly data from 1982-2016
# Now, select lat,lon and 1982-2011
fAPAR1982_2011 <- pre.mat[,c(1:360)]
dim(fAPAR1982_2011)

final_fAPAR <- rowMeans(fAPAR1982_2011,na.rm = TRUE)
summary(final_fAPAR)

fAPAR_input <- as.data.frame(cbind(lonlat,final_fAPAR))
names(fAPAR_input) <- c("lon","lat","fAPAR")

#fAPAR_input is a dataframe, including 3 columns: lon, lat, age (age is our values)
#1.convert dataframe to grids
coordinates(fAPAR_input) <- ~lon+lat 
gridded(fAPAR_input) <- TRUE

#2. check grids information and convert it to raster
class(fAPAR_input)
str(fAPAR_input@data)

r3 <- raster(fAPAR_input, "fAPAR") 

#3. Have a look at global map
class(r3)
plot(r3)
```

#alpha

```{r}
library(raster)
alphalist <- list.files(path = "E:/C-N cycling/Carbon allocation/672 sites analysis/alpha/",full.names = T) #Input alpha from a list of data frame from 1901 to 2016
empty_alpha <- data.frame(matrix(NA)) 

#calculate alpha within 30 years (1982-2011)
for (i in 82:111){ #here 82:111 means 1982-2011
  load(file = alphalist[82])
  empty_alpha[1:259200,i-81] <- rowMeans(SP_result_monthly,na.rm = TRUE)
}

final_alpha <- rowMeans(empty_alpha,na.rm = TRUE)

#alpha_input is a dataframe, including 3 columns: lon, lat, age (age is our values)
alpha_input <- as.data.frame(cbind(lonlat,final_alpha))
names(alpha_input) <- c("lon","lat","alpha")

coordinates(alpha_input) <- ~lon+lat 
gridded(alpha_input) <- TRUE

#2. check grids information and convert it to raster
class(alpha_input)
str(alpha_input@data)

r4 <- raster(alpha_input, "alpha") 

#3. Have a look at global map
class(r4)
plot(r4)
r4
``` 



