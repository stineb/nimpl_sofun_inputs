---
output:
  html_document: default
  pdf_document: default
  word_document: default
---

---
title: "A test of k-nearest neighbor method"
author: "Yunke Peng"
date: "Aug 19 2020"
output: html_document
---

## Introduction about Global mapping

```{r}
library(raster)
library(ncdf4)

library(dplyr)      # for data wrangling
library(ggplot2)    # for awesome graphics
library(rsample)    # for creating validation splits
library(recipes)    # for feature engineering

# Modeling packages
library(caret)       # for fitting KNN models
library(h2o)       # for resampling and model training
library(AmesHousing)
library(modeldata)
library(rsample)
library(dslabs)
library(purrr)
library(randomForest)

#1. Input LMA, Tg, alpha, PPFD nc files from desktop/Euler.

outputdata <- function(name,max){
  #-----------------------------------------------------------------------
  # Input: name: variable (LMA, Tg, alpha, PPFD, lat)
  # Input: max: maximum value in the map (9999 as default; if omitting NA VALUES then it should be < 9999 (dummy))
  #-----------------------------------------------------------------------
  ncin <- nc_open(paste ("D:/PhD/nc/new/cdo/", name, ".nc", sep=""))
  #ncin <- nc_open(paste ("~/data/nimpl_sofun_inputs/map/Final_ncfile/" ,name, ".nc", sep=""))
  lon <- ncvar_get(ncin,"lon")
  lat<-ncvar_get(ncin,"lat")
  variable <- ncvar_get(ncin,name)
  nc_close(ncin)
  
  variabelist <- as.vector(variable)
  lonlat <- expand.grid(lon, lat)
  output_final <- as.data.frame(cbind(lonlat,variabelist))
  names(output_final) <- c("lon","lat",name)
  output_final2 <- subset(output_final,output_final[,3]<max) # to make map easy to follow, it subset a reasonable value here.
  coordinates(output_final2) <- ~lon+lat 
  gridded(output_final2) <- TRUE
  rmap <- raster(output_final2, name) 
  plot(rmap,main=name)
  return(output_final)
  #-----------------------------------------------------------------------
  # Output: plot(rmap): the presentation of global map (after subsetting max of data)
  # Output: output_final: the output data (259200 * 3) including lon, lat and value
  #-----------------------------------------------------------------------
}

LMA <- outputdata("LMA",999) # here the plot of map includes LMA values less than 999.
#Because all our inputs here from Euler have set 9999 as dummy value for all NA grids. But we will not show them necessarily in plot map. 
#However, with regard to output object (LMA, Tg, alpha, LMA), it still have number of grids = 259200, which means, all NA grids still indicated as 9999.Just keep this in mind.
summary(LMA) # g/m2
dim(LMA)

#do the same in Tg, alpha and PPFD
Tg <- outputdata("Tg",999) #degree celcius
alpha <- outputdata("alpha",999)
PPFD <- outputdata("PPFD",999)  # umol/m2/s

#2. Merge, and only select available grids in land
merge1 <-Reduce(function(x,y) merge(x = x, y = y, by = c("lon","lat"),all.x=TRUE), 
                             list(LMA,Tg,alpha,PPFD))

merge2 <- subset(merge1,PPFD<9999) #Only select Grids with available grids in PPFD map (defined as land grids).

#merge2$LMA[merge2$LMA == 9999] <- median(merge2$LMA) #convert 9999 to median of LMA, which is required later on in knn training

merge2$LMA[merge2$LMA == 9999] <- NA #convert 9999 to NA
dim(merge2)
summary(merge2) 

all_data <- merge2[,c("LMA","lat","Tg","alpha","PPFD")] # this is final input will be used in knn, which removed lon here.

training_data <- subset(all_data,LMA>0) #only select available LMA data as training data

testing_data <- subset(all_data,is.na(LMA)==TRUE)  #only select NA-LMA data as testing data, which will be used in knn at the end.

dim(training_data)
dim(testing_data)
summary(training_data)
summary(testing_data)

# 3. knn training
cv <- trainControl(
  method = "cv", 
  number = 10
)

# Create a hyperparameter grid search
hyper_grid <- expand.grid(
  k = floor(seq(5, 20, length.out = 15))
)

knn_fit <- train(LMA ~., data = training_data,
                 method = "knn",
                 trControl=cv,
                 preProcess = c("center", "scale"),
                 tuneGrid = hyper_grid)

knn_fit # it indicated k =11 as the best design, with R2=0.501, RMSE=12.15

# output prediction data and add it in testing_data
test_pred <- predict(knn_fit,newdata=testing_data)
testing_data$LMA <- test_pred

#rbind, and merge back with lon.
final <- rbind(training_data,testing_data)

lon_data <- merge2[,c("lon","lat","Tg","alpha","PPFD")]

final2 <-Reduce(function(x,y) merge(x = x, y = y, by = c("lat","Tg","alpha","PPFD"),all.x=TRUE), 
                list(final,lon_data))

#form final3 dataframe as final output, and plot
final3 <- final2[,c("lon","lat","LMA")]

coordinates(final3) <- ~lon+lat 
gridded(final3) <- TRUE
rmap <- raster(final3, "LMA") 
plot(rmap)

#5. merge it with 259200 lon/lat dataframe, convert NA to 9999, and then output to nc files

merge_all <- merge1[,c("lon","lat")]
dim(merge_all)
dim(final3)

final4 <-Reduce(function(x,y) merge(x = x, y = y, by = c("lon","lat"),all.x=TRUE), 
                list(merge_all,final3))
summary(final4)

final4[is.na(final4)] <- 9999

coordinates(final4) <- ~lon+lat 
gridded(final4) <- TRUE
rLMA <- raster(final4, "LMA") 

d <- writeRaster(rLMA, paste0("D:/PhD/nc/new/cdo/","newLMA.nc"),
                 format = "CDF", overwrite = TRUE, varname = "LMA", 
                 varunit = "g/m2", longname = "Leaf-mass-per-area", 
                 xname = "lon", yname = "lat")


#After this, this was outputed as nc file in R, and then will be processed by CDO-processing in Euler (to make coordinates consistent), and finally saved in "~/data/nimpl_sofun_inputs/map/Final_ncfile/newLMA.nc" in order to update our prediction field (LMA) in yunkebranch.

```
