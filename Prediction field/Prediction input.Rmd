---
output:
  html_document: default
  pdf_document: default
  word_document: default
---

---
title: "Global input for all prediction field"
author: "Yunke Peng"
date: "June 22 2020"
output: html_document
---

## Introduction about Global nc files

Elements below are global inputs that will be used in statistical model-based calculations:

 * Soil C/N
 * age
 * alpha
 * fAPAR
 * PPFD
 * Tg
 * vpd
 * LMA
 * Vcmax25

Each elements were derived from different sources, and some of them may be resampled from different resolutions.


#soil C/N

```{r}
library(raster)

soil <- raster('/cluster/work/climate/bestocke/data/Yunke_CNcycle/Global_grids/Original/soilCN/w001000.adf') # map input from the last 2015 version of ISRIC (Batjes 2015 ISRIC report)

Global_grid <- as.data.frame(read.csv(file="/cluster/work/climate/bestocke/data/Yunke_CNcycle/Global_grids/Original/soilCN/Global_cell.csv")) #Input global land grids (0.5 degree;N = 259200)

Global_grid$ID <- c(1:259200) #create a list of number, just helping to form a raster then.

pointXY<-SpatialPointsDataFrame(Global_grid[,c('lon','lat')], data=data.frame(unique.id=paste(Global_grid$ID))) # convert to spatial data format 

vec.soil.extract <-extract(soil,pointXY) 
data.soil.extract <-data.frame(pointXY,SUID=vec.soil.extract) 
# These two steps are important, it will extract SUID information from soil map to our grids data, so that each our global grid will have a SUID, which will be further combined (merged) with soil C/N data then.

ISRIC.data<-read.csv(file="/cluster/work/climate/bestocke/data/Yunke_CNcycle/Global_grids/Original/soilCN/HW30s_FULL.csv",header=TRUE,sep=";",dec = ".") # Now, input ISRIC database

data.soil.extract <- merge(data.soil.extract,ISRIC.data,by='SUID',all.x=TRUE) # merge site with soil variables by using SUID

data.soil.extract2 <- subset(data.soil.extract,CNrt>0) # select available CNrt
data.soil.extract3 <- data.soil.extract2[,c("lon","lat","CNrt")] # only select CNrt variable

ss1 <- aggregate(data.soil.extract3,by=list(data.soil.extract3$lon,data.soil.extract3$lat), FUN=mean, na.rm=TRUE) # note that in each grid there might be more than 1 samples measured, so we should aggregate them which make sures that one grid holds one data only.

ss2 <- ss1[,c(3,4,5)] # now,select lon, lat and CNrt only


final_CN <-Reduce(function(x,y) merge(x = x, y = y, by = c("lon","lat"),all.x=TRUE), 
                   list(Global_grid,ss2)) #merged this with global grids (N = 259200)

coordinates(final_CN) <- ~lon+lat 

gridded(final_CN) <- TRUE

rCNrt <- raster(final_CN, "CNrt") 
plot(rCNrt)

```



#stand age

```{r}
library(raster)
library(ncdf4)
#set the path and filename

ncfname <- paste ("/cluster/work/climate/bestocke/data/Yunke_CNcycle/Global_grids/Original/age/", "GFAD_V1-1", ".nc", sep="")
dname <- "age"

#1. open a netCDF file and check variable
ncin <- nc_open(ncfname)
print(ncin)
summary(ncin) #here ncin includes 4 pfts at 15 age classes

#2. Get coordinate and value
lon <- ncvar_get(ncin,"lon")
nlon <- dim(lon) 

lat<-ncvar_get(ncin,"lat")
nlat<-dim(lat)

age <-ncvar_get(ncin,"age")

nc_close(ncin)

pre.vec.long <- as.vector(age)
length(pre.vec.long)

pre.mat <- matrix(pre.vec.long, nrow = nlon * nlat, ncol = 4*15) # 259200 * 420 - here it represents 4 PFTs and 15 age classes.

lonlat <- expand.grid(lon, lat)

#here we calculated age as a sum of 15 age classes in 4 plant functional types.
lonlat$age <- rowSums(pre.mat[,1:4])*5+rowSums(pre.mat[,5:8])*15+rowSums(pre.mat[,9:12])*25+rowSums(pre.mat[,13:16])*35+
  rowSums(pre.mat[,17:20])*45+rowSums(pre.mat[,21:24])*55+rowSums(pre.mat[,25:28])*65+rowSums(pre.mat[,29:32])*75+
  rowSums(pre.mat[,33:36])*85+rowSums(pre.mat[,37:40])*95+rowSums(pre.mat[,41:44])*105+rowSums(pre.mat[,45:48])*115+
  rowSums(pre.mat[,49:52])*125+rowSums(pre.mat[,53:56])*135+rowSums(pre.mat[,57:60])*145


names(lonlat) <- c("lon","lat","age")

age_input <- as.data.frame(lonlat)

coordinates(age_input) <- ~lon+lat 
gridded(age_input) <- TRUE

#2. check grids information and convert it to raster
class(age_input)
str(age_input@data)

r <- raster(age_input, "age") 

#3. Have a look at global map
class(r)
plot(r)

``` 
