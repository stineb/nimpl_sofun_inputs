---
output:
  html_document: default
  pdf_document: default
  word_document: default
---

---
title: "Check GPP from sofun/yunkebranch_units (C3 or C3+C4) and compare it with GMD GPP"
author: "Yunke Peng"
date: "Sep 28 2020"
output: html_document
---

## GPP data description

Here it compares GMD GPP with (1) nimpl GPP for c3 plants only and (2) nimpl GPP for c3 + c4 plants. It shows that (2) has higher R2 (0.93), and many problem sites (GPP = 0) were removed in this data, where it might be because they were at the edge of land, and therefore automatically de-activated when newly including c3/c4 map in nimpl project. We have therefore used the second object (gpp_nimpl_c3c4) as the input in nimpl project.


```{r}
library(raster)
library(ncdf4)
library(maps)

#1. Input GMD GPP (fAPAR3g, 2000-2016)
# downloaded from /cluster/work/climate/bestocke/data/sofun_outputs/output_nc_global/global_BRC_fAPAR3g_v2_2000_2016.a.gpp.nc

name <- "gpp"
ncin <- nc_open(paste ("D:/PhD/nimpl_sofun_inputs/Data/GPP/GMD/", "global_BRC_fAPAR3g_v2_2000_2016.a.gpp.nc", sep=""))

lon <- ncvar_get(ncin,"lon")
lat<-ncvar_get(ncin,"lat")
gpp <- ncvar_get(ncin,name)
time <- ncvar_get(ncin,"time")
nc_close(ncin)

pre.vec.long <- as.vector(gpp)
pre.mat <- matrix(pre.vec.long, nrow = 259200, ncol = 17)

lonlat <- expand.grid(lon, lat)
gpp_final <- as.data.frame(cbind(lonlat,pre.mat[,5]))
names(gpp_final) <- c("lon","lat","gpp")
gpp_gmd <- gpp_final

#coordinates(gpp_final) <- ~lon+lat 
#gridded(gpp_final) <- TRUE
#rage <- raster(gpp_final, name) 
#plot(rage)
#title("GMD GPP (fapar3g, 2000-2016)")


######2. output nimpl/yunkebranch_units/ GPP (npft = 1, lGr3 = .TRUE.)
# create a function for output multiple years nc file map
outputdata <- function(name,year,min,max,path){
  #-----------------------------------------------------------------------
  # Input: name: variable vcmax25
  # Input: min,max: minimum and maximum value in the map.
  #-----------------------------------------------------------------------
  ncin <- nc_open(paste (path, "global.",year,".a." ,name, ".nc", sep=""))
  #ncin <- nc_open(paste ("~/data/sofun_outputs/output_nc/global/", "global.20xx.a." ,name, ".nc", sep=""))
  lon <- ncvar_get(ncin,"lon")
  lat<-ncvar_get(ncin,"lat")
  variable <- ncvar_get(ncin,name)
  nc_close(ncin)
  
  variabelist <- as.vector(variable)
  lonlat <- expand.grid(lon, lat)
  output_final <- as.data.frame(cbind(lonlat,variabelist))
  names(output_final) <- c("lon","lat",name)
  output_final2 <- subset(output_final,output_final[,3]>min & output_final[,3]<max) # to make map easy to follow, it subset a reasonable value here.
  coordinates(output_final2) <- ~lon+lat 
  gridded(output_final2) <- TRUE
  rmap <- raster(output_final2, name) 
  #plot(rmap,main=name)
  return(output_final)
  #-----------------------------------------------------------------------
  # Output: plot(rmap): the presentation of global map (after subsetting max of data)
  # Output: output_final: the output data (259200 * 3) including lon, lat and value
  #-----------------------------------------------------------------------
}

#output them in a dataframe (dim: 259200 rows * 20 years)
#outputted GPP saved in Euler /cluster/home/yunpeng/sofun_outputs/output_nc_global

gpp_17years <- data.frame(matrix(NA))

for (i in 2000:2016){
  gpp_17years[1:259200,i-2000+1] <- outputdata("gpp",i,-999999,999999,"D:/PhD/nimpl_sofun_inputs/Data/GPP/c3/")[,3]
}

lonlat <- outputdata("gpp",i,-999999,999999,"D:/PhD/nimpl_sofun_inputs/Data/GPP/c3/")[,1:2]

gpp_c3 <- cbind(lonlat,rowMeans(gpp_17years,na.rm = TRUE))

names(gpp_c3) <- c("lon","lat","gpp")

gpp_c3data <- gpp_c3

#coordinates(gpp_c3) <- ~lon+lat 
#gridded(gpp_c3) <- TRUE
#rgpp1 <- raster(gpp_c3, "gpp") 
#plot(rgpp1)
#title("GPP from nimpl/yunkebranch_units/ (npft = 1, lGr3 = .TRUE.)")


gpp_gmd_c3 <- cbind(gpp_gmd,gpp_c3data[,3])
names(gpp_gmd_c3) <- c("lon","lat","gpp_gmd","gpp_nimpl_c3")

######3. output nimpl/yunkebranch_units/ GPP (npft = 2, lGr3 and lGr4 = .TRUE.)
library(tidyverse)  # depends
library(ncmeta)
library(viridis)
library(ggthemes)
library(LSD)
library(yardstick)
library(ggplot2)
library(RColorBrewer)
library(dplyr)
library(gplots)
library(tidyselect)
library(extrafont)
devtools::load_all("D:/PhD/nimpl_sofun_inputs/package/rbeni")
library(rbeni)
library(raster)
library(spgwr)
library(maps)

#1. In our path (with multiple years data), identify which is the first year and end year of those files
firstyr_data <- 1980 # In data file, which is the first year
endyr_data <- 2018 # In data file, which is the last year
location <- "D:/PhD/nimpl_sofun_inputs/Data/output/"
alloutput_list <- list.files(location,full.names = T)

#2. Create a function to specify path, loop many years nc file and output a dataframe (lon, lat, var).
inputnc <- function(name,start_year,end_year){
  #-----------------------------------------------------------------------
  # Input: 
  # name: gpp, npp, anpp, vcmax25, leafcn, nuptake...
  # start_year: e.g. 1981
  # end_year: e.g. 2016
  # location: e.g "D:/PhD/nimpl_sofun_inputs/Data/output/" or in Euler: "~/yunkebranch_units/outputnc/"
  #-----------------------------------------------------------------------
  output_allyears <- data.frame(matrix(NA))
  # first, include all years annual data into a daframe
  for (i in firstyr_data:endyr_data){
    if (name == "npp"){
      nc <- read_nc_onefile(alloutput_list[grepl("a.npp.nc", list.files(location,full.names = T))][i-firstyr_data+1]) #we only rely this to filter npp.nc file...
    } else {
      nc <- read_nc_onefile(alloutput_list[grepl(name, list.files(location,full.names = T))][i-firstyr_data+1]) #Input nc
    }
    output_year <- nc_to_df(nc, varnam = name)[,3] #Yearly output
    output_allyears[1:259200,i-firstyr_data+1] <- output_year #here first column represents first year of data file 's output
  }
  names(output_allyears) <- paste(name,firstyr_data:endyr_data,sep="")
  #this variable above (output_allyears), could be end of the function, which is variable at multiple years. But for our purporses, we need mean of select years
  #then, only calculate means of selected years
  output_selected_yrs <- rowMeans(output_allyears[,(start_year-firstyr_data+1):(end_year-firstyr_data+1)],na.rm = TRUE) # only calculated means based on selected start and end year (see function)
  coord <- nc_to_df(nc, varnam = name)[,1:2] # obtain lon and lat
  final_output <- cbind(coord,elev[,3],output_selected_yrs) # combine lon, lat,z with rowmeans variable
  names(final_output) <- c("lon","lat","z",name)
  return(final_output)
  #-----------------------------------------------------------------------
  # Output: output_final: the output data (259200 * 3) including lon, lat and value
  #-----------------------------------------------------------------------
}

#select data over 30 years, each df includes lon, lat, z, var
gpp_df <- inputnc("gpp",2000,2016)

gpp_gmd_c3_c3c4 <- cbind(gpp_gmd_c3,gpp_df[,4])
names(gpp_gmd_c3_c3c4) <- c("lon","lat","gpp_gmd","gpp_nimpl_c3","gpp_nimpl_c3c4")
summary(gpp_gmd_c3_c3c4)

######4. Compare GMD GPP with (1)nimpl_c3 and (2) nimpl_c3c4 (we used this in nimpl finally) 
analyse_modobs2(subset(gpp_gmd_c3_c3c4,gpp_nimpl_c3c4>0),"gpp_gmd","gpp_nimpl_c3", type = "points")
analyse_modobs2(subset(gpp_gmd_c3_c3c4,gpp_nimpl_c3c4>0),"gpp_gmd","gpp_nimpl_c3c4", type = "points")

```
