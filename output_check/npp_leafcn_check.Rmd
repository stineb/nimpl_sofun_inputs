---
output:
  html_document: default
  pdf_document: default
  word_document: default
---

---
title: "Output GPP, NPP, NPP[tissues], leaf C/N from sofun/yunkebranch_units, and compare it with site-level data"
author: "Yunke Peng"
date: "Sep 28 2020"
output: html_document
---

##Here the main steps were:
* Input nc files (from multiple years), and obtain mean of multiple years, then generating a dataframe for each variable.

* Input site-level GPP, NPP, ANPP, BNPP, LNPP (leaf NPP), WNPP (wood NPP), and leaf C/N (which is consistent to the samples used in statistical models earlier).

* Extract site-level variable from Global map output (predictions), based on geographically weighted regressions analysis

* Compare site obs. vs. pred.

* Output map of each output, as a brief check.

* Study sites of NPP, and leaf C/N

```{r}
library(tidyverse)  # depends
library(ncmeta)
library(viridis)
library(ggthemes)
library(LSD)
library(yardstick)
library(ggplot2)
library(RColorBrewer)
library(dplyr)
library(gplots)
library(tidyselect)
library(extrafont)
devtools::load_all("D:/PhD/nimpl_sofun_inputs/package/rbeni")
library(rbeni)
library(raster)
library(spgwr)
library(maps)

#1. In our path (with multiple years data), identify which is the first year and end year of those files
firstyr_data <- 1980 # In data file, which is the first year
endyr_data <- 2018 # In data file, which is the last year
location <- "D:/PhD/nimpl_sofun_inputs/Data/output/"
alloutput_list <- list.files(location,full.names = T)

#input elevation nc file, which will be cbind with global df directly
#nc <- read_nc_onefile("~/data/watch_wfdei/WFDEI-elevation.nc")
elev_nc <- read_nc_onefile("D:/PhD/nimpl_sofun_inputs/Data/Elevation/WFDEI-elevation.nc")
elev <- as.data.frame(nc_to_df(elev_nc, varnam = "elevation"))
head(elev) # this is consistent with df coord below

#2. Create a function to specify path, loop many years nc file and output a dataframe (lon, lat, var).
inputnc <- function(name,start_year,end_year){
  #-----------------------------------------------------------------------
  # Input: 
  # name: gpp, npp, anpp, vcmax25, leafcn, nuptake...
  # start_year: e.g. 1981
  # end_year: e.g. 2016
  # location: e.g "D:/PhD/nimpl_sofun_inputs/Data/output/" or in Euler: "~/yunkebranch_units/outputnc/"
  #-----------------------------------------------------------------------
  output_allyears <- data.frame(matrix(NA))
  # first, include all years annual data into a daframe
  for (i in firstyr_data:endyr_data){
    if (name == "npp"){
      nc <- read_nc_onefile(alloutput_list[grepl("a.npp.nc", list.files(location,full.names = T))][i-firstyr_data+1]) #we only rely this to filter npp.nc file...
    } else {
      nc <- read_nc_onefile(alloutput_list[grepl(name, list.files(location,full.names = T))][i-firstyr_data+1]) #Input nc
    }
    output_year <- nc_to_df(nc, varnam = name)[,3] #Yearly output
    output_allyears[1:259200,i-firstyr_data+1] <- output_year #here first column represents first year of data file 's output
  }
  names(output_allyears) <- paste(name,firstyr_data:endyr_data,sep="")
  #this variable above (output_allyears), could be end of the function, which is variable at multiple years. But for our purporses, we need mean of select years
  #then, only calculate means of selected years
  output_selected_yrs <- rowMeans(output_allyears[,(start_year-firstyr_data+1):(end_year-firstyr_data+1)],na.rm = TRUE) # only calculated means based on selected start and end year (see function)
  coord <- nc_to_df(nc, varnam = name)[,1:2] # obtain lon and lat
  final_output <- cbind(coord,elev[,3],output_selected_yrs) # combine lon, lat,z with rowmeans variable
  names(final_output) <- c("lon","lat","z",name)
  return(final_output)
  #-----------------------------------------------------------------------
  # Output: output_final: the output data (259200 * 3) including lon, lat and value
  #-----------------------------------------------------------------------
}

#select data over 30 years, each df includes lon, lat, z, var
gpp_df <- inputnc("gpp",1982,2011)

npp_df <- inputnc("npp",1982,2011)

anpp_df <- inputnc("anpp",1982,2011)

bnpp_df <- inputnc("bnpp",1982,2011)

lnpp_df <- inputnc("lnpp",1982,2011)

wnpp_df <- inputnc("wnpp",1982,2011)

leafcn_df <- inputnc("leafcn",2007,2018) # this is actually leaf n/c. We used this time period, because this is when all leaf C/N data collected
leafcn_df$leafcn <- 1/leafcn_df$leafcn # we converted it to leaf c/n here.

lnf <- inputnc("lnf",1982,2011) 

wnf <- inputnc("wnf",1982,2011) 

bnf <- inputnc("bnf",1982,2011) 

bnf <- inputnc("nuptake",1982,2011) 

#3. Input NPP and leafCN site-based data
# (1) pre-processing NPP
# rbind data (more data details see https://github.com/yunkepeng/nimpl_sofun_inputs/blob/master/NPP/NPP_statistical_model.Rmd)
NPP_SaraVicca <- read.csv(file="D:/PhD/nimpl_sofun_inputs/Data/NPP/NPP_SaraVicca/NPP_SaraVicca.csv")
NPP_Malhi <- read.csv(file="D:/PhD/nimpl_sofun_inputs/Data/NPP/NPP_Malhi/NPP_Malhi.csv")
NPP_Keith <- read.csv(file="D:/PhD/nimpl_sofun_inputs/Data/NPP/NPP_Keith/NPP_Keith.csv")
NPP_Forc <- read.csv(file="D:/PhD/nimpl_sofun_inputs/Data/NPP/NPP_Forc/NPP_Forc.csv")
NPP_all <- rbind(NPP_SaraVicca,NPP_Malhi,NPP_Keith,NPP_Forc)

# structure dataframe for NPP in tissues
gpp_site <- aggregate(GPP~lon+lat+z,data=NPP_all[,c("lon","lat","z","GPP")],mean,na.rm=TRUE)
dim(gpp_site)

npp_site <- aggregate(TNPP_1~lon+lat+z,data=NPP_all[,c("lon","lat","z","TNPP_1")],mean,na.rm=TRUE)
dim(npp_site)

anpp_site <- aggregate(ANPP_2~lon+lat+z,data=NPP_all[,c("lon","lat","z","ANPP_2")],mean,na.rm=TRUE)
dim(anpp_site) # Comparing with above, 50 of 310 samples have measured ANPP, but not NPP (due to lack of BNPP)

bnpp_site <- aggregate(BNPP_1~lon+lat+z,data=NPP_all[,c("lon","lat","z","BNPP_1")],mean,na.rm=TRUE)
dim(bnpp_site)

lnpp_site <- aggregate(NPP.foliage~lon+lat+z,data=NPP_all[,c("lon","lat","z","NPP.foliage")],mean,na.rm=TRUE)
dim(lnpp_site)

wnpp_site <- aggregate(NPP.wood~lon+lat+z,data=NPP_all[,c("lon","lat","z","NPP.wood")],mean,na.rm=TRUE)
dim(wnpp_site)

# (2) pre-processing leaf c/n
leafCN <- read.csv(file="D:/PhD/nimpl_sofun_inputs/Data/CN_leaf/final_leafCN.csv")

# make species consitent
for (i in 1:nrow(leafCN)){
  if (is.na(leafCN$species2[i]) == TRUE){
    leafCN$final_species[i]<- leafCN$species[i]} else { 
      leafCN$final_species[i]<- paste(leafCN$species[i],sep=" ",leafCN$species2[i])} 
}

# remove unreasonable outliers
leafCN2 <- subset(leafCN,Vcmax.25>0&Vcmax.25<300&cn>1&cn<100&lma>0&lma<700)

# aggregate from species to site-mean leaf C/N
leafcn_site <- aggregate(cn~lon+lat+Elevation,leafCN2,mean)
names(leafcn_site) <- c("lon","lat","z","leafcn")
summary(leafcn_site)
dim(leafcn_site) # we will use this database for model validation later on.


#4. Start geographically weighted regressions 
# Now, both global_df and site_df have included four columns: lon, lat, z, var
a <- 1.5 # which degree (distance) of grid when interpolating gwr from global grids
i <- 1
#we have not wrote functions here, becaue it may help to trace about our prediction (NA always occurs that stops the process)
#GPP
for (i in c(1:nrow(gpp_site))){
  gpp_global <- na.omit(gpp_df)
  gpp_part <- subset(gpp_global,lon>(gpp_site[i,1]-a)&lon<(gpp_site[i,1]+a)&
                       lat>(gpp_site[i,2]-a)&lat<(gpp_site[i,2]+a))
  coordinates(gpp_part) <- c("lon","lat")
  gridded(gpp_part) <- TRUE
  
  gpp_coord <- gpp_site[i,1:3]
  coordinates(gpp_coord) <- c("lon","lat")
  gpp_site$pred[i] <- (gwr(gpp ~ z, gpp_part, bandwidth = 1.06, fit.points =gpp_coord,predictions=TRUE))$SDF$pred
}

#NPP
for (i in c(1:nrow(npp_site))){
  npp_global <- na.omit(npp_df)
  npp_part <- subset(npp_global,lon>(npp_site[i,1]-a)&lon<(npp_site[i,1]+a)&
                       lat>(npp_site[i,2]-a)&lat<(npp_site[i,2]+a))
  coordinates(npp_part) <- c("lon","lat")
  gridded(npp_part) <- TRUE
  
  npp_coord <- npp_site[i,1:3]
  coordinates(npp_coord) <- c("lon","lat")
  npp_site$pred[i] <- (gwr(npp ~ z, npp_part, bandwidth = 1.06, fit.points =npp_coord,predictions=TRUE))$SDF$pred
}


#anpp: some points cannot be interpolated (focused grids = NA), which needs to be skipped
for (i in c(2:12,14:26,28:34,37:45,47:54,56:60,62:248,250:nrow(anpp_site))){
  anpp_global <- na.omit(anpp_df)
  anpp_part <- subset(anpp_global,lon>(anpp_site[i,1]-a)&lon<(anpp_site[i,1]+a)&
                        lat>(anpp_site[i,2]-a)&lat<(anpp_site[i,2]+a))
  coordinates(anpp_part) <- c("lon","lat")
  gridded(anpp_part) <- TRUE
  
  anpp_coord <- anpp_site[i,1:3]
  coordinates(anpp_coord) <- c("lon","lat")
  anpp_site$pred[i] <- (gwr(anpp ~ z, anpp_part, bandwidth = 1.06, fit.points =anpp_coord,predictions=TRUE))$SDF$pred
}

#bnpp
for (i in c(1:nrow(bnpp_site))){
  bnpp_global <- na.omit(bnpp_df)
  bnpp_part <- subset(bnpp_global,lon>(bnpp_site[i,1]-a)&lon<(bnpp_site[i,1]+a)&
                        lat>(bnpp_site[i,2]-a)&lat<(bnpp_site[i,2]+a))
  coordinates(bnpp_part) <- c("lon","lat")
  gridded(bnpp_part) <- TRUE
  
  bnpp_coord <- bnpp_site[i,1:3]
  coordinates(bnpp_coord) <- c("lon","lat")
  bnpp_site$pred[i] <- (gwr(bnpp ~ z, bnpp_part, bandwidth = 1.06, fit.points =bnpp_coord,predictions=TRUE))$SDF$pred
}

#lnpp
lnpp_site$pred <- NA
for (i in c(2:5,7:17,19:23,26:32,34:36,38:42,44:189,191:nrow(lnpp_site))){
  lnpp_global <- na.omit(lnpp_df)
  lnpp_part <- subset(lnpp_global,lon>(lnpp_site[i,1]-a)&lon<(lnpp_site[i,1]+a)&
                        lat>(lnpp_site[i,2]-a)&lat<(lnpp_site[i,2]+a))
  coordinates(lnpp_part) <- c("lon","lat")
  gridded(lnpp_part) <- TRUE
  
  lnpp_coord <- lnpp_site[i,1:3]
  coordinates(lnpp_coord) <- c("lon","lat")
  lnpp_site[i,5]  <- (gwr(lnpp ~ z, lnpp_part, bandwidth = 1.06, fit.points = lnpp_coord, predictions=TRUE))$SDF$pred
  #print(i)
}

#wnpp
wnpp_site$pred <- NA
for (i in c(2:4,6:15,17:20,23:29,31:33,35:39,41:174,176:nrow(wnpp_site))){
  wnpp_global <- na.omit(wnpp_df)
  wnpp_part <- subset(wnpp_global,lon>(wnpp_site[i,1]-a)&lon<(wnpp_site[i,1]+a)&
                        lat>(wnpp_site[i,2]-a)&lat<(wnpp_site[i,2]+a))
  coordinates(wnpp_part) <- c("lon","lat")
  gridded(wnpp_part) <- TRUE
  
  wnpp_coord <- wnpp_site[i,1:3]
  coordinates(wnpp_coord) <- c("lon","lat")
  wnpp_site[i,5] <- (gwr(wnpp ~ z, wnpp_part, bandwidth = 1.06, fit.points =wnpp_coord,predictions=TRUE))$SDF$pred
  #print(i)
}

#leafcn
for (i in c(1:nrow(leafcn_site))){
  leafcn_global <- na.omit(leafcn_df)
  leafcn_part <- subset(leafcn_global,lon>(leafcn_site[i,1]-a)&lon<(leafcn_site[i,1]+a)&
                          lat>(leafcn_site[i,2]-a)&lat<(leafcn_site[i,2]+a))
  coordinates(leafcn_part) <- c("lon","lat")
  gridded(leafcn_part) <- TRUE
  
  leafcn_coord <- leafcn_site[i,1:3]
  coordinates(leafcn_coord) <- c("lon","lat")
  leafcn_site$pred[i] <- (gwr(leafcn ~ z, leafcn_part, bandwidth = 1.06, fit.points =leafcn_coord,predictions=TRUE))$SDF$pred
}



#add pft data derived from orginal data provided from Sara Vicca
#Evergreen <- read.csv(file="~/data/NPP_Yunke/NPP_SaraVicca/orig/pft.csv")
Evergreen <- read.csv(file="D:/PhD/nimpl_sofun_inputs/Data/NPP/NPP_SaraVicca/orig/pft.csv")
pft_type <- merge(NPP_all,Evergreen,by=c("site"),all.x=TRUE)
pft_type2 <- pft_type[,c("lon","lat","z","pft")]
pft_type3 <- unique(pft_type2)
dim(pft_type3)
nonforest <- pft_type3 %>% filter(pft == "Grassland" |pft == "Plantation"|pft == "Cropland")
dim(nonforest)
#we realized that there are only 36 of 347 sites are NOT forest. We filtered it at here, 
# which makes it easy to merge with our GPP, NPP...sites.
nonforest 
#we noticed that row 22 and 23 has the same site, but one notified as Cropland another notified as grassland, perhaps from different sources
#this classfication is really not important, so let's delete one safely (so that it will not cause trouble when merging)
nonforest <- nonforest[c(1:22,24:26),]

#now, let's merge nonforest df to each GPP, NPP...dataset
gpp_site <- merge(gpp_site,nonforest,by=c("lon","lat","z"),all.x=TRUE)
npp_site <- merge(npp_site,nonforest,by=c("lon","lat","z"),all.x=TRUE)
anpp_site <- merge(anpp_site,nonforest,by=c("lon","lat","z"),all.x=TRUE)
bnpp_site <- merge(bnpp_site,nonforest,by=c("lon","lat","z"),all.x=TRUE)
lnpp_site <- merge(lnpp_site,nonforest,by=c("lon","lat","z"),all.x=TRUE)
wnpp_site <- merge(wnpp_site,nonforest,by=c("lon","lat","z"),all.x=TRUE)

#see below, it is clear that only anpp and gpp dataset has available non-forest data.
#They both have 25 samples (non-forest) separately.
dim(subset(gpp_site,pft!="NA"))
dim(subset(npp_site,pft!="NA"))
dim(subset(anpp_site,pft!="NA"))
dim(subset(bnpp_site,pft!="NA"))
dim(subset(lnpp_site,pft!="NA"))
dim(subset(wnpp_site,pft!="NA"))

#5. compare mod vs. obs 
#As mentioned above, we can only compare forest vs. non-forest in GPP and NPP analysis.
#non-forest GPP
gpp_nonforest <- subset(gpp_site, pft!="NA")
dim(gpp_nonforest)
analyse_modobs2(subset(gpp_nonforest,pred>0),"GPP","pred", type = "points",
                filnam = "D:/PhD/nimpl_sofun_inputs/fig/gpp.png")

gpp_forest <- subset(gpp_site, is.na(pft)==TRUE)
dim(gpp_forest)
analyse_modobs2(subset(gpp_forest,pred>0),"GPP","pred", type = "points",
                filnam = "D:/PhD/nimpl_sofun_inputs/fig/gpp.png")

gpp_all <- gpp_site
analyse_modobs2(subset(gpp_all,pred>0),"GPP","pred", type = "points",
                filnam = "D:/PhD/nimpl_sofun_inputs/fig/gpp.png")

# it is clear that forest GPP (N = 138) shows better performance than forest + non-forest GPP (N =162), and than non-forest GPP (N = 24)

analyse_modobs2(subset(npp_site,pred>0),"TNPP_1","pred", type = "points",
                filnam = "D:/PhD/nimpl_sofun_inputs/fig/npp.png")

#divide anpp into forest vs. non-forest
anpp_nonforest <- subset(anpp_site, pft!="NA")
dim(anpp_nonforest)
analyse_modobs2(subset(anpp_nonforest,pred>0),"ANPP_2","pred", type = "points",
                filnam = "D:/PhD/nimpl_sofun_inputs/fig/anpp.png")

anpp_forest <- subset(anpp_site, is.na(pft)==TRUE)
dim(anpp_forest)
analyse_modobs2(subset(anpp_forest,pred>0),"ANPP_2","pred", type = "points",
                filnam = "D:/PhD/nimpl_sofun_inputs/fig/anpp.png")

anpp_all <- anpp_site
analyse_modobs2(subset(anpp_all,pred>0),"ANPP_2","pred", type = "points",
                filnam = "D:/PhD/nimpl_sofun_inputs/fig/anpp.png")

#non-forest ANPP: R2 =0.3, n =24. which is better than forest or forest+non-forest anpp.

analyse_modobs2(subset(bnpp_site,pred>0),"BNPP_1","pred", type = "points",
                filnam = "D:/PhD/nimpl_sofun_inputs/fig/bnpp.png")

analyse_modobs2(subset(lnpp_site,pred>0),"NPP.foliage","pred", type = "points",
                filnam = "D:/PhD/nimpl_sofun_inputs/fig/lnpp.png")

analyse_modobs2(subset(wnpp_site,pred>0),"NPP.wood","pred", type = "points",
                filnam = "D:/PhD/nimpl_sofun_inputs/fig/wnpp.png")

analyse_modobs2(subset(leafcn_site,pred>0),"leafcn","pred", type = "points",
                filnam = "D:/PhD/nimpl_sofun_inputs/fig/leafcn.png")

#6. Represent, and save our maps
#(1) gpp
gg <- plot_map3(gpp_df[,c(1,2,4)], 
          varnam = "gpp",plot_title = " GPP (gC/m2/yr)",
          latmin = -65, latmax = 85)
gg
ggsave("D:/PhD/nimpl_sofun_inputs/fig/map_gpp.png",plot = gg)

#(2) npp  
gg<- plot_map3(npp_df[,c(1,2,4)], 
          varnam = "npp",plot_title = " NPP (gC/m2/yr)",
          latmin = -65, latmax = 85) 
gg
ggsave("D:/PhD/nimpl_sofun_inputs/fig/map_npp.png",plot = gg)

#(3) anpp
gg<- plot_map3(anpp_df[,c(1,2,4)], 
               varnam = "anpp",plot_title = "Aboveground NPP (gC/m2/yr)",
               latmin = -65, latmax = 85) 
gg
ggsave("D:/PhD/nimpl_sofun_inputs/fig/map_anpp.png",plot = gg)

#(4) bnpp
gg<- plot_map3(bnpp_df[,c(1,2,4)], 
               varnam = "bnpp",plot_title = "Belowground NPP (gC/m2/yr)",
               latmin = -65, latmax = 85) 
gg
ggsave("D:/PhD/nimpl_sofun_inputs/fig/map_bnpp.png",plot = gg)

#(5) lnpp
gg<- plot_map3(lnpp_df[,c(1,2,4)], 
               varnam = "lnpp",plot_title = "NPP allocated to leaves (gC/m2/yr)",
               latmin = -65, latmax = 85) 
gg
ggsave("D:/PhD/nimpl_sofun_inputs/fig/map_lnpp.png",plot = gg)

#(6) wnpp
gg<- plot_map3(wnpp_df[,c(1,2,4)], 
               varnam = "wnpp",plot_title = "NPP allocated to woods (gC/m2/yr)",
               latmin = -65, latmax = 85) 
gg
ggsave("D:/PhD/nimpl_sofun_inputs/fig/map_wnpp.png",plot = gg)

#(7) leafcn
gg<- plot_map3(leafcn_df[,c(1,2,4)], 
               varnam = "leafcn",plot_title = "Leaf carbon to nitrogen ratio",
               latmin = -65, latmax = 85) 
gg
ggsave("D:/PhD/nimpl_sofun_inputs/fig/map_leafcn.png",plot = gg)

#7. Mapping our global measured sites
map("world", fill=TRUE, col="white", bg="white", ylim=c(-90, 90),xlim = c(-180,180), mar=c(1,0,0,1))
points(anpp_site$lon,anpp_site$lat, col="black", pch=16,cex=1.5)
points(npp_site$lon,npp_site$lat, col="red", pch=16,cex=1.5)
points(gpp_site$lon,gpp_site$lat, col="orange", pch=16,cex=1.5)
title("Orange: GPP + NPP + ANPP
       Red: NPP + ANPP
       Black: ANPP")

map("world", fill=TRUE, col="white", bg="white", ylim=c(-90, 90),xlim = c(-180,180), mar=c(1,0,0,1))
points(leafcn_site$lon,leafcn_site$lat, col="red", pch=16,cex=1.5)
title("leaf C/N")

```
